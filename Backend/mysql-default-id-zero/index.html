<!DOCTYPE html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>MySQL primary key 使用 default 關鍵字產生 0 | Lynk is here</title><meta name=description content="最近在工作中，同事操作資料庫進行 INSERT 操作時，每次新增的 id 都會被設為 0。起初我們以為這是 ORM 的 Bug，因此決定更換另一款 ORM；然而，即使更換後問題依舊存在。這時我們開始懷疑並非 ORM 的問題。後來我在本地端進行測試時，一切都運行正常，但在使用遠端資料庫時，id 仍然被設置為 0。顯然，這是由於遠端資料庫的某些設定所導致的。本文將記錄我們如何解決這個問題。"><link rel=icon type=image/x-icon href=/tech-blog/images/favicon.ico><meta property=og:type content=website><meta property=og:url content=https://link1515.github.io/tech-blog><meta property=og:title content="MySQL primary key 使用 default 關鍵字產生 0 | Lynk is here"><meta property=og:description content="最近在工作中，同事操作資料庫進行 INSERT 操作時，每次新增的 id 都會被設為 0。起初我們以為這是 ORM 的 Bug，因此決定更換另一款 ORM；然而，即使更換後問題依舊存在。這時我們開始懷疑並非 ORM 的問題。後來我在本地端進行測試時，一切都運行正常，但在使用遠端資料庫時，id 仍然被設置為 0。顯然，這是由於遠端資料庫的某些設定所導致的。本文將記錄我們如何解決這個問題。"><meta property=og:image content=/tech-blog/images/cover/mysql-id-0.jpg><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="MySQL primary key 使用 default 關鍵字產生 0 | Lynk is here"><meta name=twitter:description content="最近在工作中，同事操作資料庫進行 INSERT 操作時，每次新增的 id 都會被設為 0。起初我們以為這是 ORM 的 Bug，因此決定更換另一款 ORM；然而，即使更換後問題依舊存在。這時我們開始懷疑並非 ORM 的問題。後來我在本地端進行測試時，一切都運行正常，但在使用遠端資料庫時，id 仍然被設置為 0。顯然，這是由於遠端資料庫的某些設定所導致的。本文將記錄我們如何解決這個問題。"><meta name=twitter:image content=/tech-blog/images/cover/mysql-id-0.jpg><link rel=stylesheet href=/tech-blog/lib/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css><link rel=stylesheet href=/tech-blog/lib/prismjs/prism.min.css><link rel=stylesheet href=/tech-blog/lib/prismjs/prism-vsc-dark-plus.css><link rel=stylesheet href=/tech-blog/css/main.css><meta name=generator content="Hexo 7.3.0"></head><body data-bs-theme=dark><script>const theme=window.localStorage.getItem("theme")??"";document.body.dataset.bsTheme=theme</script><div class="min-vh-100 d-flex flex-column"><nav id=navbar class="navbar navbar-expand-lg bg-body-tertiary sticky-top shadow-sm"><div class=container-lg><a id=logo class=navbar-brand href=/tech-blog/ ><img class=me-1 src=/tech-blog/images/logo.png height=50 alt=logo> Lynk is here </a><button class="navbar-toggler px-2" type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent><i class="bi bi-list icon-20"></i></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ms-auto mb-2 mb-lg-0"><li class=nav-item><a class=nav-link href=/tech-blog/ ><i class="bi bi-house-fill icon-20"></i> 首頁</a></li><li class=nav-item><a class=nav-link href=/tech-blog/archives><i class="bi bi-list-ul icon-20"></i> 列表</a></li><li class=nav-item><a class=nav-link href=/tech-blog/categories><i class="bi bi-folder-fill icon-20"></i> 分類</a></li><li class=nav-item><a class=nav-link href=/tech-blog/tags><i class="bi bi-tags-fill icon-20"></i> 標籤</a></li></ul><div class="d-flex justify-content-center"><button id=toggleThemeBtn class="toggleThemeBtn btn" style=border:none><i class="bi bi-lightbulb-fill icon-20"></i></button> <button id=searchBtn class="searchBtn btn" style=border:none data-bs-toggle=modal data-bs-target=#searchModal><i class="bi bi-search icon-20"></i></button></div></div></div></nav><div class="flex-grow-1 container-lg mt-4 mb-5"><div class=post><h1>MySQL primary key 使用 default 關鍵字產生 0</h1><small class=text-body-secondary><time datetime=2024-06-24T08:55:42.000Z>2024-06-24</time></small><hr><div class="d-flex flex-column gap-2 mb-4"><div><div class="d-flex flex-wrap gap-2"><a href=/tech-blog/categories/Backend/ class="btn btn-secondary btn-sm"><i class="bi bi-folder-fill icon-15"></i> Backend</a></div></div><div><div class="tagLinks d-flex flex-wrap gap-2"><a href=/tech-blog/tags/MySQL/ class="btn btn-secondary btn-sm"><i class="bi bi-tag-fill icon-15"></i> MySQL</a></div></div></div><div class="text-center mb-4"><img class="img-fluid rounded" width=1200 height=630 src=/tech-blog/images/cover/mysql-id-0.jpg alt=cover></div><div class=content><p>最近在工作中，同事操作資料庫進行 INSERT 操作時，每次新增的 id 都會被設為 0。起初我們以為這是 ORM 的 Bug，因此決定更換另一款 ORM；然而，即使更換後問題依舊存在。這時我們開始懷疑並非 ORM 的問題。後來我在本地端進行測試時，一切都運行正常，但在使用遠端資料庫時，id 仍然被設置為 0。顯然，這是由於遠端資料庫的某些設定所導致的。本文將記錄我們如何解決這個問題。</p><h2 id=問題重現><a href=#問題重現 class=headerlink title=問題重現></a>問題重現</h2><p>簡單創建一個 <code>users</code> 表，其中有 <code>id</code> 與 <code>full_name</code> 欄位，且 <code>id</code> 為 <code>primary key</code> 與 <code>AUTO_INCREMENT</code></p><pre class=language-SQL data-language=SQL><code class=language-SQL>CREATE TABLE &#96;users&#96; (
  &#96;id&#96; INT NOT NULL AUTO_INCREMENT,
  &#96;full_name&#96; varchar(256) DEFAULT NULL,
  PRIMARY KEY (&#96;id&#96;)
) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;22 DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_0900_ai_ci;</code></pre><p>使用 ORM 執行 <code>INSERT</code> 時，產生以下 SQL 語句，可以注意這邊有將 <code>id</code> 設定成 <code>default</code>，這是這次問題產生的主要原因。此時會創建一個 <code>id</code> 為 <code>0</code> 的 <code>user</code>，如果再執行一次就會嘗試再次產生一個 <code>id</code> 為 <code>0</code> 的 <code>user</code>，而報出錯誤 <code>Duplicate entry &#39;0&#39; for key &#39;PRIMARY&#39;</code></p><pre class=language-SQL data-language=SQL><code class=language-SQL>INSERT INTO &#96;users&#96; (&#96;id&#96;, &#96;full_name&#96;) VALUES (default, &#39;Terry&#39;);</code></pre><h2 id=解決辦法><a href=#解決辦法 class=headerlink title=解決辦法></a>解決辦法</h2><p>經過研究發現遠端的資料庫有一項設定 <code>NO_AUTO_VALUE_ON_ZERO</code>，它會將我們的 <code>AUTO_INCREMENT</code> 的 <code>default</code> 改成 <code>0</code></p><pre class=language-SQL data-language=SQL><code class=language-SQL>SELECT @@sql_mode;
-- ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_AUTO_VALUE_ON_ZERO,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</code></pre><p>要取消此設定，有兩種方法，一種是到遠端機器上設定並重新啟動資料庫，另一種就是在每次連線時進行設定，這裡演示後者。方法也比較簡單，就是在建立連線後，直接設定 <code>sql_mode</code>，將 <code>NO_AUTO_VALUE_ON_ZERO</code> 去除</p><pre class=language-SQL data-language=SQL><code class=language-SQL>SET @@sql_mode &#x3D; &#39;ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION&#39;;</code></pre><p>後續就可以正常的進行 <code>INSERT</code> 操作</p></div></div></div><footer class="footer border-top text-center py-3"><div class="container-lg text-body-secondary">© Copyright 2024 By Terry Lin</div></footer></div><div class="modal fade" id=searchModal tabindex=-1><div class=modal-dialog><div class=modal-content><div class=modal-body><div class="position-relative mb-3"><input id=searchInput class=form-control type=search style=padding-left:2.25rem> <span class="position-absolute top-50 translate-middle-y search-icon" style=left:.75rem><i class="bi bi-search"></i></span></div><div id=searchResults class="list-group list-group-flush"></div><div id=searchNoResult class="list-group list-group-flush" style=display:none><span class=list-group-item>查無結果</span></div></div></div></div></div><div class=goTopBtn><button id=goTopBtn class=shadow-sm><i class="bi bi-chevron-up"></i></button></div><script src=/tech-blog/lib/bootstrap/bootstrap.bundle.min.js></script><script src=/tech-blog/lib/prismjs/prism.min.js></script><script src=/tech-blog/lib/fuse/fuse.js></script><script src=/tech-blog/js/utils.js></script><script src=/tech-blog/js/main.js type=module></script></body></html>