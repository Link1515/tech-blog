<!DOCTYPE html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>透過 PHP 來了解 Basic Auth | Lynk is here</title><meta name=description content="Basic Auth 是 HTTP 協定的一種認證機制，允許伺服器要求使用者提供使用者名稱和密碼才能存取受保護的資源。本文章將先講解 Basic Auth 整體流程，再透過 PHP 進行實作。"><link rel=icon type=image/x-icon href=/images/favicon.ico><meta property=og:type content=website><meta property=og:url content=https://blog.lynkishere.us.kg><meta property=og:title content="透過 PHP 來了解 Basic Auth | Lynk is here"><meta property=og:description content="Basic Auth 是 HTTP 協定的一種認證機制，允許伺服器要求使用者提供使用者名稱和密碼才能存取受保護的資源。本文章將先講解 Basic Auth 整體流程，再透過 PHP 進行實作。"><meta property=og:image content=/images/cover/basic-auth.jpg><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="透過 PHP 來了解 Basic Auth | Lynk is here"><meta name=twitter:description content="Basic Auth 是 HTTP 協定的一種認證機制，允許伺服器要求使用者提供使用者名稱和密碼才能存取受保護的資源。本文章將先講解 Basic Auth 整體流程，再透過 PHP 進行實作。"><meta name=twitter:image content=/images/cover/basic-auth.jpg><link rel=stylesheet href=/lib/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css><link rel=stylesheet href=/lib/prismjs/prism.min.css><link rel=stylesheet href=/lib/prismjs/prism-vsc-dark-plus.css><link rel=stylesheet href=/css/main.css><meta name=generator content="Hexo 7.3.0"></head><body data-bs-theme=dark><script>const theme=window.localStorage.getItem("theme")??"";document.body.dataset.bsTheme=theme</script><div class="min-vh-100 d-flex flex-column"><nav id=navbar class="navbar navbar-expand-lg bg-body-tertiary sticky-top shadow-sm"><div class=container-lg><a id=logo class=navbar-brand href=/ ><img class=me-1 src=/images/logo.png height=50 alt=logo> Lynk is here </a><button class="navbar-toggler px-2" type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent><i class="bi bi-list icon-20"></i></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ms-auto mb-2 mb-lg-0"><li class=nav-item><a class=nav-link href=/ ><i class="bi bi-house-fill icon-20"></i> 首頁</a></li><li class=nav-item><a class=nav-link href=/archives><i class="bi bi-list-ul icon-20"></i> 列表</a></li><li class=nav-item><a class=nav-link href=/categories><i class="bi bi-folder-fill icon-20"></i> 分類</a></li><li class=nav-item><a class=nav-link href=/tags><i class="bi bi-tags-fill icon-20"></i> 標籤</a></li></ul><div class="d-flex justify-content-center"><button id=toggleThemeBtn class="toggleThemeBtn btn" style=border:none><i class="bi bi-lightbulb-fill icon-20"></i></button> <button id=searchBtn class="searchBtn btn" style=border:none data-bs-toggle=modal data-bs-target=#searchModal><i class="bi bi-search icon-20"></i></button></div></div></div></nav><div class="flex-grow-1 container-lg mt-4 mb-5"><div class=post><h1>透過 PHP 來了解 Basic Auth</h1><small class=text-body-secondary><time datetime=2024-03-23T00:00:00.000Z>2024-03-23</time></small><hr><div class="d-flex flex-column gap-2 mb-4"><div><div class="d-flex flex-wrap gap-2"><a href=/categories/Backend/ class="btn btn-secondary btn-sm"><i class="bi bi-folder-fill icon-15"></i> Backend</a></div></div><div><div class="tagLinks d-flex flex-wrap gap-2"><a href=/tags/PHP/ class="btn btn-secondary btn-sm"><i class="bi bi-tag-fill icon-15"></i> PHP </a><a href=/tags/Basic-Auth/ class="btn btn-secondary btn-sm"><i class="bi bi-tag-fill icon-15"></i> Basic Auth</a></div></div></div><div class="text-center mb-4"><img class="img-fluid rounded" width=1200 height=630 src=/images/cover/basic-auth.jpg alt=cover></div><div class=content><p>Basic Auth 是 HTTP 協定的一種認證機制，允許伺服器要求使用者提供使用者名稱和密碼才能存取受保護的資源。本文章將先講解 Basic Auth 整體流程，再透過 PHP 進行實作。</p><h2 id=Basic-Auth-流程><a href=#Basic-Auth-流程 class=headerlink title="Basic Auth 流程"></a>Basic Auth 流程</h2><ol><li>伺服器端 Response Header 帶上 <code>WWW-Authenticate: Basic realm=&quot;My Realm&quot;</code></li><li>瀏覽器端就會看到一個彈窗要求使用者輸入帳號密碼</li><li>瀏覽器將使用者的帳號與密碼以 <code>帳號:密碼</code> 的格式編碼為 <code>Base64</code>，並在 Request Header 上帶 <code>Authorization: Basic [編碼後的用戶帳密]</code></li><li>這組帳密會保存於瀏覽器中，之後請求自動帶上</li><li>伺服器驗證帳號密碼，成功即返回 200，失敗則返回 401</li></ol><blockquote><p>需要注意，用戶的帳號密碼在傳輸時為明碼，可以直接解譯 Base64</p></blockquote><h2 id=Basic-Auth-實作><a href=#Basic-Auth-實作 class=headerlink title="Basic Auth 實作"></a>Basic Auth 實作</h2><h3 id=產生帳密彈窗><a href=#產生帳密彈窗 class=headerlink title=產生帳密彈窗></a>產生帳密彈窗</h3><p>直接在 header 上加入 <code>WWW-Authenticate: Basic realm=&quot;My Realm&quot;</code>，也加入 401 的 Http Status Code</p><p><img src=/images/posts/basic-auth-by-php/auth-challenge.jpg alt=auth-challenge></p><pre class=language-PHP data-language=PHP><code class=language-PHP>header(&#39;WWW-Authenticate: Basic realm&#x3D;&quot;My Realm&quot;&#39;);
http_response_code(401);</code></pre><h3 id=用戶輸入帳密><a href=#用戶輸入帳密 class=headerlink title=用戶輸入帳密></a>用戶輸入帳密</h3><p>假設正確的帳號密碼為:</p><p>帳號: user1234<br>密碼: pass1234</p><p>我們在瀏覽器上輸入此帳密進行登入，並透過 <code>F12</code> 開發者工具的 <code>Network</code> 標籤查看請求</p><p><img src=/images/posts/basic-auth-by-php/request.jpg alt=auth-challenge></p><p>在 Response Headers 發現我們帶的 <code>Www-Authenticate</code>，以及在 Request Headers 瀏覽器帶上的 <code>Authorization: Basic dXNlcjEyMzQ6cGFzczEyMzQ=</code></p><p>我們可以對 <code>dXNlcjEyMzQ6cGFzczEyMzQ=</code> 進行 <code>base64</code> 解譯，可以看到這段字串實際上是 <code>user1234:pass1234</code>。由此可知，使用 Basic Auth 驗證時為明碼傳遞，需要小心資安問題</p><p><a target=_blank rel=noopener href=https://emn178.github.io/online-tools/base64_decode.html>Base64 Decode</a></p><p><img src=/images/posts/basic-auth-by-php/base64-decode.jpg alt=base64-decode></p><h2 id=完整伺服器驗證帳密><a href=#完整伺服器驗證帳密 class=headerlink title=完整伺服器驗證帳密></a>完整伺服器驗證帳密</h2><h3 id=1-自行解析><a href=#1-自行解析 class=headerlink title="1. 自行解析"></a>1. 自行解析</h3><pre class=language-PHP data-language=PHP><code class=language-PHP>&#x2F;&#x2F; 定義正確的帳號與密碼
define(&#39;USERNAME&#39;, &#39;user1234&#39;);
define(&#39;PASSWORD&#39;, &#39;pass1234&#39;);

$headers &#x3D; getallheaders(); &#x2F;&#x2F; request headers
$pass &#x3D; false; &#x2F;&#x2F; 是否通過 basic auth，預設為 false

&#x2F;&#x2F; 檢查 request headers 上是否有 Authorization，並且此 Authorization 必須以 &#39;Basic &#39; 開頭
if (isset ($headers[&#39;Authorization&#39;]) || preg_match(&#39;&#x2F;Basic &#x2F;&#39;, $headers[&#39;Authorization&#39;])) &#123;
  &#x2F;&#x2F; 去除 Authorization 上的 &#39;Basic &#39; 字串取得 base64 編碼後的帳密
  $base64Auth &#x3D; preg_replace(&#39;&#x2F;Basic &#x2F;&#39;, &#39;&#39;, $headers[&#39;Authorization&#39;]);
  &#x2F;&#x2F; 解譯帳密，並用 : 隔成陣列，即變成 [&#39;user1234&#39;, &#39;pass1234&#39;]
  $auth &#x3D; explode(&#39;:&#39;, base64_decode($base64Auth));
  &#x2F;&#x2F; 分別取出帳號密碼
  $username &#x3D; $auth[0];
  $password &#x3D; $auth[1];

  &#x2F;&#x2F; 比對帳號密碼是否正確
  $pass &#x3D; $username &#x3D;&#x3D;&#x3D; USERNAME &amp;&amp; $password &#x3D;&#x3D;&#x3D; PASSWORD;
&#125;

&#x2F;&#x2F; 如果沒有通過 Basic Auth 就還是響應 WWW-Authenticate
if (!$pass) &#123;
  header(&#39;WWW-Authenticate: Basic realm&#x3D;&quot;My Realm&quot;&#39;);
  http_response_code(401);
  exit;
&#125;</code></pre><h3 id=2-透過-PHP-全域變數><a href=#2-透過-PHP-全域變數 class=headerlink title="2. 透過 PHP 全域變數"></a>2. 透過 PHP 全域變數</h3><p>使用 PHP 時，其全域變數 <code>$_SERVER</code> 上就會自動幫我們解析 Basic Auth 的帳密，帳號為 <code>$_SERVER[&quot;PHP_AUTH_USER&quot;]</code>，密碼為 <code>$_SERVER[&quot;PHP_AUTH_PW&quot;]</code>，因此可以改寫為</p><pre class=language-PHP data-language=PHP><code class=language-PHP>define(&#39;USERNAME&#39;, &#39;user1234&#39;);
define(&#39;PASSWORD&#39;, &#39;pass1234&#39;);


$pass &#x3D; false;

if (isset ($_SERVER[&#39;PHP_AUTH_USER&#39;]) &amp;&amp; isset ($_SERVER[&#39;PHP_AUTH_PW&#39;])) &#123;
  $pass &#x3D; 
    $_SERVER[&#39;PHP_AUTH_USER&#39;] &#x3D;&#x3D;&#x3D; USERNAME &amp;&amp; 
    $_SERVER[&#39;PHP_AUTH_PW&#39;] &#x3D;&#x3D;&#x3D; PASSWORD;
&#125;

if (!$pass) &#123;
  header(&#39;WWW-Authenticate: Basic realm&#x3D;&quot;My Realm&quot;&#39;);
  http_response_code(401);
  exit;
&#125;</code></pre></div></div></div><footer class="footer border-top text-center py-3"><div class="container-lg text-body-secondary">© Copyright 2024 By Terry Lin</div></footer></div><div class="modal fade" id=searchModal tabindex=-1><div class=modal-dialog><div class=modal-content><div class=modal-body><div class="position-relative mb-3"><input id=searchInput class=form-control type=search style=padding-left:2.25rem> <span class="position-absolute top-50 translate-middle-y search-icon" style=left:.75rem><i class="bi bi-search"></i></span></div><div id=searchResults class="list-group list-group-flush"></div><div id=searchNoResult class="list-group list-group-flush" style=display:none><span class=list-group-item>查無結果</span></div></div></div></div></div><div class=goTopBtn><button id=goTopBtn class=shadow-sm><i class="bi bi-chevron-up"></i></button></div><script src=/lib/bootstrap/bootstrap.bundle.min.js></script><script src=/lib/prismjs/prism.min.js></script><script src=/lib/fuse/fuse.js></script><script src=/js/utils.js></script><script src=/js/main.js type=module></script></body></html>